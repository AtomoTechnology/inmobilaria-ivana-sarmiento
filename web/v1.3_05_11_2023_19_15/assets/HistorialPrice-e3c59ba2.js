import{r as n,f as w,j as a,L as Y,a as s,h as A}from"./index-3ed1fa78.js";import{u as ge,H as fe,D as L,C as o,a as ke,M as ye}from"./HeaderData-f8341142.js";import{B as xe}from"./Box-2f3a3966.js";import{C as Ne,F as Ce}from"./FormActionBtns-c23092d4.js";import{C as E}from"./CustomInput-6ca7ad9c.js";import{u as ve,F as z}from"./FormError-a3fab181.js";import{R as Pe,D as we}from"./RequestError-ce21148f.js";import{F as G}from"./FieldsetGroup-13ce1fee.js";import{u as Ae}from"./useContracts-759ab8e3.js";import{E as Ee}from"./EditIcon-72ee5f20.js";import{f as q,e as K,a as Me}from"./date-8ced1934.js";import{v as Fe}from"./form-3a2308eb.js";import{D as Se}from"./DeleteIcon-e6cc714b.js";import{B as He}from"./BoxContainerPage-d81583a3.js";import"./useQuery-6083f14c.js";const _e=()=>{var j,B,T,O,$,R,V;const[U,p]=n.useState(!1),[M,x]=n.useState(!1),{amount:_,percent:J,year:Q,ContractId:De,values:g,handleInputChange:N,updateAll:C,reset:f}=ve({ContractId:0,amount:0,year:0,percent:0}),{showAndHideModal:i}=ge(),[F,h]=n.useState(!1),[W,X]=n.useState(""),[c,S]=n.useState(),[k,H]=n.useState(!1),[D,Z]=n.useState({global:{value:null,matchMode:w.CONTAINS},"Client.fullName":{value:null,matchMode:w.CONTAINS},"PropertyType.description":{value:null,matchMode:w.CONTAINS}}),u=n.useRef(),b=n.useRef(),[ee,ae]=n.useState(),{data:v,isError:re,isLoading:te,error:se,isFetching:oe,refetch:P}=Ae("?state=Finalizado:ne"),le=e=>{C({...e}),p(!0),H(!0),b.current=e},de=e=>{x(!M),b.current=e},ne=async e=>{var r;try{h(!0);const t=await A.delete("/price-historial/"+e);t.data.ok?(P(),x(!1),i("Borrado",t.data.message)):i("Error",t.data.message||"Algo malo ocurrío.","red")}catch(t){t.response&&i("Error",((r=t.response.data)==null?void 0:r.message)||"Algo malo ocurrío.","red")}finally{h(!1)}},ie=e=>{f(),H(!1),b.current=null,u.current=e;let r=e.PriceHistorials.sort((d,m)=>d.id-m.id)[e.PriceHistorials.length-1].year,t=e.PriceHistorials.sort((d,m)=>d.id-m.id)[e.PriceHistorials.length-1].amount;C({...g,year:r+1,amount:t,ContractId:e.id}),p(!0)},I=()=>{f(),p(!1),S({})},ce=e=>{const r=e;let t={...D};t.global.value=r,Z(t),X(r)},me=e=>a("div",{className:"flex gap-x-3 items-center justify-start",children:e.PriceHistorials.length<=2&&a("div",{onClick:()=>ie(e),className:"btn-add-price ",title:"Ajustar precio siguiente año",children:a(ye,{title:"Ajustar precio",size:25})})}),ue=async e=>{var d,m,y;e.preventDefault();const{error:r,ok:t}=Fe({...g});if(S(r),!t)return!1;if(k)try{h(!0);const l=await A.put(`/price-historial/${(d=b.current)==null?void 0:d.id}`,{...g});l.data.ok?(P(),f(),p(!1),i("Editado",l.data.message)):i("Error",l.data.message||"Algo malo ocurrío.","red")}catch(l){l.response&&i("Error",((m=l.response.data)==null?void 0:m.message)||"Algo malo ocurrío.","red")}finally{h(!1)}else try{h(!0);const l=await A.post("/price-historial",{...g});l.data.ok?(P(),f(),p(!1),i("Guardado",l.data.message)):i("Error",l.data.message||"Algo malo ocurrío.","red")}catch(l){l.response&&i("Error",((y=l.response.data)==null?void 0:y.message)||"Algo malo ocurrío.","red")}finally{h(!1)}},be=e=>(e==null?void 0:e.PriceHistorials.length)>0||!1,he=e=>s("div",{className:"p-3",children:[a("h2",{className:"text-lg font-semibold",children:"Histórico de precio"}),s(L,{size:"small",dataKey:"id",className:"!overflow-hidden   !border-none",responsiveLayout:"scroll",value:e.PriceHistorials,children:[a(o,{field:"amount",body:r=>s("span",{children:[" $ ",r.amount," "]}),header:"Monto",headerClassName:"!border-none dark:!bg-gray-800 dark:!text-slate-400",className:"dark:bg-slate-700 dark:text-slate-400 dark:!border-slate-600 ",sortable:!0}),a(o,{header:"Año",field:"year",headerClassName:"!border-none dark:!bg-gray-800 dark:!text-slate-400",className:"dark:bg-slate-700 dark:text-slate-400 dark:!border-slate-600 ",sortable:!0}),a(o,{header:"Porcentaje",field:"percent",headerClassName:"!border-none dark:!bg-gray-800 dark:!text-slate-400",className:"dark:bg-slate-700 dark:text-slate-400 dark:!border-slate-600 "}),a(o,{headerClassName:"!border-none dark:!bg-gray-800 dark:!text-slate-400",className:"dark:bg-slate-700 dark:text-slate-400 dark:!border-slate-600 ",field:"createdAt",body:r=>s("span",{children:[" ",Me(r.createdAt)," "]}),header:"Fecha"}),a(o,{body:pe,headerClassName:"!border-none dark:!bg-gray-800",className:"dark:bg-slate-700 dark:text-slate-400 dark:!border-slate-600 ",exportable:!1,style:{width:90}})]})]}),pe=e=>s("div",{className:"flex gap-x-3 items-center justify-center",children:[a(Ee,{action:()=>le(e)}),a(Se,{action:()=>de(e)})]});return te?a(Y,{}):re?a(Pe,{error:se}):s(He,{children:[a(fe,{showBtn:!1,action:()=>{},text:"Histórico de precio de los Contratos"}),a(E,{onChange:e=>ce(e),className:" w-auto mx-2 sm:mx-0 sm:w-96",initialValue:W,placeholder:"Buscar contrato",type:"search"}),a(xe,{className:"!p-0 !overflow-hidden !border-none sm:mx-0   mb-4 ",children:s(L,{expandedRows:ee,onRowToggle:e=>ae(e.data),rowExpansionTemplate:he,size:"small",emptyMessage:"Aún no hay contrato",className:"!overflow-hidden   !border-none",value:v==null?void 0:v.data,filters:D,globalFilterFields:["Property.street","Client.fullName"],dataKey:"id",responsiveLayout:"scroll",children:[a(o,{expander:be,headerClassName:"!border-none dark:!bg-gray-800 dark:!text-slate-400",className:"dark:bg-slate-700 dark:text-slate-400 dark:!border-slate-600 ",style:{width:"0.5rem"}}),a(o,{field:"Property.street",body:e=>s("span",{children:[e.Property.street," ",e.Property.number," ",e.Property.floor," ",e.Property.dept]}),header:"Propiedad",headerClassName:"!border-none dark:!bg-gray-800 dark:!text-slate-400",className:"dark:bg-slate-700 dark:text-slate-400 dark:!border-slate-600 ",sortable:!0}),a(o,{field:"Property.folderNumber",header:"Carpeta",headerClassName:"!border-none dark:!bg-gray-800 dark:!text-slate-400",className:"dark:bg-slate-700 dark:text-slate-400 dark:!border-slate-600 ",sortable:!0}),a(o,{field:"Client.fullName",body:e=>s("span",{children:[e.Client.fullName," ",s("span",{className:"text-sm",children:[" (",e.Client.cuit,") "]})]}),header:"Inquilino",headerClassName:"!border-none dark:!bg-gray-800 dark:!text-slate-400",className:"dark:bg-slate-700 dark:text-slate-400 dark:!border-slate-600 ",sortable:!0}),a(o,{field:"startDate",header:"Fecha inicio",body:e=>a("span",{children:q(e.startDate)}),headerClassName:"!border-none dark:!bg-gray-800 dark:!text-slate-400",className:"dark:bg-slate-700 dark:text-slate-400 dark:!border-slate-600 ",sortable:!0}),a(o,{field:"endDate",header:"Fecha fin",body:e=>a("span",{children:q(e.endDate)}),headerClassName:"!border-none dark:!bg-gray-800 dark:!text-slate-400",className:"dark:bg-slate-700 dark:text-slate-400 dark:!border-slate-600 ",sortable:!0}),a(o,{field:"state",header:"Estado",sortable:!0,body:e=>s("span",{className:`font-bold ${e.state==="En curso"?"text-green-500":"text-red-500"}`,children:[e.state," "]}),headerClassName:"!border-none dark:!bg-gray-800 dark:!text-slate-400",className:"dark:bg-slate-700 dark:text-slate-400 dark:!border-slate-600 "}),a(o,{field:"",header:"Año",body:e=>a("span",{className:`${K(e.startDate,new Date().toISOString().slice(0,10))===3&&"text-yellow-500 font-bold"}`,children:K(e.startDate,new Date().toISOString().slice(0,10))}),headerClassName:"!border-none dark:!bg-gray-800 dark:!text-slate-400",className:"dark:bg-slate-700 dark:text-slate-400 dark:!border-slate-600 "}),a(o,{field:"",header:"Monto Actual",body:e=>{var r;return s("span",{children:["$ ",(r=e.PriceHistorials.sort((t,d)=>t.id-d.id)[e.PriceHistorials.length-1])==null?void 0:r.amount]})},headerClassName:"!border-none dark:!bg-gray-800 dark:!text-slate-400",className:"dark:bg-slate-700 dark:text-slate-400 dark:!border-slate-600 "}),a(o,{body:me,headerClassName:"!border-none dark:!bg-gray-800",className:"dark:bg-slate-700 dark:text-slate-400 dark:!border-slate-600 ",exportable:!1,style:{width:50}})]})}),oe&&a(Y,{h:40,w:40}),a(ke,{show:M,setShow:x,savingOrUpdating:F,destroy:()=>{var e;return ne((e=b.current)==null?void 0:e.id)},text:` El precio del ${(j=b.current)==null?void 0:j.year} año con el monto de  $ ${(B=b.current)==null?void 0:B.amount}`}),a(Ne,{show:U,closeModal:I,overlayClick:!1,titleText:"Ajustar precio",className:"shadow-none border-0 max-w-[500px]",children:s("form",{onSubmit:ue,children:[a(G,{children:a(E,{disabled:!0,initialValue:k?(T=b.current)==null?void 0:T.ContractId:((O=u.current)==null?void 0:O.Client.fullName)+" - "+(($=u.current)==null?void 0:$.Client.cuit)+"  | "+((R=u.current)==null?void 0:R.Property.street)+" "+((V=u.current)==null?void 0:V.Property.number)+" ",label:"Contrato",onChange:e=>{},placeholder:""})}),a(E,{placeholder:"40",type:"number",min:0,initialValue:J,label:"Porcentaje de aumento",onChange:e=>{var r,t,d;if((r=u.current)!=null&&r.PriceHistorials){let m=(d=u.current)==null?void 0:d.PriceHistorials[((t=u.current)==null?void 0:t.PriceHistorials.length)-1].amount,y=m*(Number(e)/100);C({...g,amount:Number(y.toFixed(2))+m,percent:Number(e)})}else N(e,"percent")},hasError:c==null?void 0:c.percent,errorText:"El porcentaje  es obligatorio.[1,100]"}),s(G,{children:[s("fieldset",{children:[a("label",{htmlFor:"amount",children:"Monto"}),a("input",{placeholder:"123.99",disabled:!k,type:"number",value:_,onChange:e=>N(e.target.value,"amount")}),(c==null?void 0:c.amount)&&a(z,{text:"El monto del cliente es obligatorio."})]}),s("fieldset",{className:"",children:[a("label",{htmlFor:"year",children:"Año"}),a(we,{value:Q,disabled:!k,onChange:e=>N(e.value,"year"),options:[1,2,3],placeholder:"Elije el año",name:"year",className:"h-[42px] items-center !border-gray-200 dark:!border-gray-700 shadow dark:bg-slate-900 dark:!text-slate-400 "}),(c==null?void 0:c.year)&&a(z,{text:"El año  es obligatorio."})]})]}),a(Ce,{savingOrUpdating:F,onClose:I})]})})]})};export{_e as default};
